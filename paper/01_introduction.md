Introduction
============

Bitcoin, the cryptocurrency with the largest market capitalization, has inherently limited scalability. Bitcoin generates 1 block of transactions every 10 minutes and the size of that block is limited to 1MB. With a basic transaction taking up 250 bytes and an average transaction size of 500 bytes the network has a maximum capacity of 4000 transactions per block and an average capacity of 2000 transactions per block. This boils down to 3-7 transactions per second. Increasing this capacity by either increasing the block size or the rate at which blocks are generated reduces the security of the Bitcoin network [@Sompolinsky2015]. Increasing scalability of Bitcoin without abandoning security remains desirable. Firstly because if the amount of transactions being broadcasted exceeds the capacity of the network, the law of supply and demand dictates that the transaction fees will increase [@Jordan2019] Secondly, if we want to achieve a viable alternative to current centralized payment networks we need to achieve comparable throughput which is in the order of magnitude of several thousand transactions per second.

It was Satoshi Nakamoto, the mysterious pseudonymous person or group of persons famous for developing Bitcoin, who suggested the use of transaction replacement for something he called high frequency trading [@Hearn2013]. In Nakamoto's proposal a group of parties could keep updating a transaction that had yet to be committed. The order of the updates was kept by a sequence number. Only the last agreed upon transaction needed to be broadcast. By doing so all the transactions prior to the final transaction were kept off-chain. The proposed solution depended on miners to commit the final transaction (the transaction with the highest sequence number). Since there is no incentive for miners to respect the sequence number [@Harding2015], one of the involved parties could collude with a miner to have a non-final version committed, possibly stealing funds from the other parties. As such the solution couldn't operate in a trustless environment.

The scalability issues that face Bitcoin have renewed the interest in some form of transaction replacement by using them in a payment channel network (PCN). LN has emerged as the most prominent PCN to date [@Malavolta2017] and is currently the only PCN in production. 

LN is a peer-to-peer (P2P) network of connected nodes that uses Poon-Dryja [@Poon2016] payment channels. Two connected nodes can open up a payment channel between them. A transaction from node $A$ to node $B$ can only happen if there is enough balance on the side of node $A$. Likewise, a transaction from node $B$ to node $A$ can only happen if there is enough balance on the side of node $B$. Both balances added together define the capacity of the channel. To create a transaction between two nodes that don't have a payment channel between them, multiple payment channels can be connected to form a route, as long as the balances along that route allow for the payment. This is known as a multi-hop payment. To participate in LN you have to run LN client software. Each LN client follows the LN specifications, set out in the Basis of Lightning Technology (BOLT) [@BOLT] documents.

Balances on the other hand are kept private and are never broadcasted on the network. The only balances known to a node are the balances of the channels that node participates in. Because of this it is impossible to know upfront whether a multi-hop payment will succeed, and there is only one way to find out: executing the payment. By executing multiple (fake) payments it is possible to probe the unknown balance of a payment channel. Disclosing balances this way has been dubbed the balance discovery attack (BDA) [@Herrera-Joancomarti2019]. LN uses an onion routing [@Reed1998] scheme called Sphinx [@Danezis2009] for the routing of payments.

In this study we analyzed potential BDA algorithm improvements and the role of LN client software in BDA. We propose an improvement to the basic algorithm for BDA that achieves a two-fold increase of the upper limit of balances that can be disclosed. Furthermore, we found that in certain situations LN client software can be leveraged to remove the upper limit of BDA completely. Finally we describe a specific situation where the interplay between different LN client software types leads to the permanent shutdown of a payment channel. This new attack, dubbed Payment of Death (POD), makes it possible to remotely shut down channels. We will show that POD is a threat to integrity of LN, as it has the potential for a malicious party to shutdown 17.5% of the network capacity.
